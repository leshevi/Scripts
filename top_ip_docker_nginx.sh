#!/usr/bin/env bash

# --------------------------------------------
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ñ‚Ð¾Ð¿-N IP-Ð°Ð´Ñ€ÐµÑÐ¾Ð² Ð² Ð»Ð¾Ð³Ð°Ñ…
# ÐÐ²Ñ‚Ð¾Ñ€: @bash_srv
# --------------------------------------------

# ÐŸÑƒÑ‚ÑŒ Ðº Ð»Ð¾Ð³-Ñ„Ð°Ð¹Ð»Ñƒ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ /var/log/nginx/access.log)
LOGFILE="/home/leshevi/nginx/log/access.log"

# Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ñ€ÐµÑÐ¾Ð² Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 10)
TOP_N=10

# Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð²ÑÐµÑ… IP
TEMP="/tmp/all_ips_$(date +%Y%m%d_%H%M%S).txt"
# Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð±Ð¾Ñ‚ Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼
BOT_TOKEN=""
CHAT_ID=""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ñ‡Ñ‚Ð¾ Ð»Ð¾Ð³-Ñ„Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if [[ ! -f "$LOGFILE" ]]; then
  echo "âŒ Ð›Ð¾Ð³-Ñ„Ð°Ð¹Ð» '$LOGFILE' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
  exit 1
fi

echo "ðŸ”Ž Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ IP-Ð°Ð´Ñ€ÐµÑÐ° Ð¸Ð· $LOGFILE Ð¸ Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð¾Ð¿ $TOP_N..."

# 1. Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑÑ‚Ð¾Ð»Ð±ÐµÑ† (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ñ‚Ð°Ð¼ IP), Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð²Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
awk '{print $NF}' "$LOGFILE" > "$TEMP"

OUTPUT="/tmp/top_ips_report.txt"
sort "$TEMP" | uniq -c | sort -nr | head -n "$TOP_N" > "$OUTPUT"
curl -F chat_id="$CHAT_ID" -F document=@"$OUTPUT" https://api.telegram.org/bot"$BOT_TOKEN"/sendDocument
# 3. Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
rm -f "$TEMP"
